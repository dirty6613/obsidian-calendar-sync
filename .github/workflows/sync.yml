name: Sync ICS from Gist

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download obsidian.ics from Gist
        run: |
          curl -L "https://gist.githubusercontent.com/dirty6613/7f7e071ef111f1225742cdcdcd841bb9/raw/obsidian.ics" -o obsidian.ics

      - name: Sanitize and patch events
        run: |
          awk '
            BEGIN { skip_location=0 }
            /^LOCATION:/ { next }
            /^BEGIN:VEVENT/ { inside_event=1; dtstart=""; dtend_found=0; print; next }
            /^END:VEVENT/ {
              if (inside_event && dtstart != "" && dtend_found == 0) {
                if (dtstart ~ /^[0-9]{8}$/) {
                  y = substr(dtstart,1,4)
                  m = substr(dtstart,5,2)
                  d = substr(dtstart,7,2)+1
                  if (d < 10) d = "0"d
                  if (d > 31) d = "01"  # crude rollover fallback
                  print "DTEND;VALUE=DATE:" y m d
                }
              }
              print
              inside_event=0
              next
            }
            /^DTSTART(;VALUE=DATE)?:/ {
              split($0, a, ":")
              dtstart = a[2]
              print
              next
            }
            /^DTEND/ { dtend_found=1; print; next }
            /^SUMMARY:/ {
              summary = $0
              gsub(/^[^A-Za-z0-9]+/, "", summary)
              gsub(/#[^ ]+/, "", summary)
              print summary
              next
            }
            { print }
          ' obsidian.ics > cleaned.ics
          mv cleaned.ics obsidian.ics

      - name: Commit and push changes
        run: |
          git config user.name "sync-bot"
          git config user.email "bot@users.noreply.github.com"
          git add obsidian.ics
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update obsidian.ics from Gist (cleaned)"
            git push
          fi
