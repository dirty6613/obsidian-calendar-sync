name: Sync ICS from Gist

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download obsidian.ics from Gist
        run: |
          curl -L "https://gist.githubusercontent.com/dirty6613/7f7e071ef111f1225742cdcdcd841bb9/raw/obsidian.ics" -o obsidian.ics

      - name: Rewrite .ics with full compatibility
        run: |
          cat <<EOF | python3
from datetime import datetime, timedelta

input_path = "obsidian.ics"
output_path = "obsidian.ics"

def clean_summary(summary):
    summary = summary.strip("ðŸ”²â­âš ï¸ðŸ’¡â—âœ…").strip()
    summary = summary.split(" #")[0].strip()
    return summary or "Untitled"

output = []
events = []
with open(input_path, "r") as f:
    lines = f.readlines()

in_event = False
event_type = None
event_data = {}
for line in lines:
    line = line.strip()
    if line == "BEGIN:VEVENT" or line == "BEGIN:VTODO":
        in_event = True
        event_type = line
        event_data = {
            "UID": "",
            "DTSTART": "",
            "SUMMARY": "",
            "LOCATION": "",
            "TYPE": event_type
        }
    elif line == "END:VEVENT" or line == "END:VTODO":
        in_event = False
        if event_type == "BEGIN:VEVENT" and event_data["DTSTART"]:
            try:
                dt = datetime.strptime(event_data["DTSTART"], "%Y%m%d")
                dtend = (dt + timedelta(days=1)).strftime("%Y%m%d")

                events.append("BEGIN:VEVENT\n")
                events.append(f"UID:{datetime.utcnow().timestamp()}@obsidian-calendar\n")
                events.append(f"DTSTAMP:{datetime.utcnow().strftime('%Y%m%dT%H%M%SZ')}\n")
                events.append(f"DTSTART;VALUE=DATE:{event_data['DTSTART']}\n")
                events.append(f"DTEND;VALUE=DATE:{dtend}\n")
                events.append(f"SUMMARY:{clean_summary(event_data['SUMMARY'])}\n")
                events.append("END:VEVENT\n")
            except Exception:
                pass
        elif event_type == "BEGIN:VTODO":
            events.append("BEGIN:VTODO\n")
            events.append(f"UID:{event_data['UID'] or str(datetime.utcnow().timestamp())}@obsidian-calendar\n")
            events.append(f"SUMMARY:{clean_summary(event_data['SUMMARY'])}\n")
            if event_data['LOCATION']:
                events.append(f"LOCATION:{event_data['LOCATION']}\n")
            events.append("STATUS:NEEDS-ACTION\n")
            events.append("END:VTODO\n")
    elif in_event:
        if line.startswith("UID:"):
            event_data["UID"] = line[4:]
        elif line.startswith("DTSTART:"):
            event_data["DTSTART"] = line.split(":")[1]
        elif line.startswith("SUMMARY:"):
            event_data["SUMMARY"] = line[8:]
        elif line.startswith("LOCATION:"):
            event_data["LOCATION"] = line

with open(output_path, "w") as f:
    f.write("BEGIN:VCALENDAR\n")
    f.write("VERSION:2.0\n")
    f.write("METHOD:PUBLISH\n")
    f.write("PRODID:-//obsidian-ical//EN\n")
    f.write("X-WR-CALNAME:Obsidian Calendar\n")
    f.write("CALSCALE:GREGORIAN\n")
    f.write("BEGIN:VTIMEZONE\n")
    f.write("TZID:UTC\n")
    f.write("BEGIN:STANDARD\n")
    f.write("DTSTART:19710101T000000\n")
    f.write("TZOFFSETFROM:+0000\n")
    f.write("TZOFFSETTO:+0000\n")
    f.write("END:STANDARD\n")
    f.write("END:VTIMEZONE\n")
    for line in events:
        f.write(line)
    f.write("END:VCALENDAR\n")
EOF

      - name: Commit and push changes
        run: |
          git config user.name "sync-bot"
          git config user.email "bot@users.noreply.github.com"
          git add obsidian.ics
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update obsidian.ics from Gist (cleaned)"
            git push
