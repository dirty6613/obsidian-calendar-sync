name: Sync ICS from Gist

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download obsidian.ics from Gist
        run: |
          curl -L "https://gist.githubusercontent.com/dirty6613/7f7e071ef111f1225742cdcdcd841bb9/raw/obsidian.ics" -o obsidian.ics

      - name: Sanitize and patch events
        run: |
          awk '
            function next_day(date,    y, m, d, t, newdate) {
              y = substr(date, 1, 4)
              m = substr(date, 5, 2)
              d = substr(date, 7, 2)
              t = m "/" d "/" y
              cmd = "date -d \"" t " +1 day\" +%Y%m%d"
              cmd | getline newdate
              close(cmd)
              return newdate
            }
      
            /^BEGIN:VEVENT/ { inside=1; dtstart=""; dtend=0; print; next }
            /^END:VEVENT/ {
              if (inside && dtstart != "" && dtend == 0 && length(dtstart) == 8) {
                print "DTEND;VALUE=DATE:" next_day(dtstart)
              }
              print
              inside=0
              next
            }
            /^DTSTART(;VALUE=DATE)?:/ {
              split($0, a, ":")
              dtstart = a[2]
              print
              next
            }
            /^DTEND/ { dtend=1; print; next }
            /^LOCATION:/ { next }
            /^SUMMARY:/ {
              s = $0
              gsub(/^[^A-Za-z0-9]+/, "", s)
              gsub(/#[^ ]+/, "", s)
              print s
              next
            }
            { print }
          ' obsidian.ics > cleaned.ics
          mv cleaned.ics obsidian.ics

      - name: Commit and push changes
        run: |
          git config user.name "sync-bot"
          git config user.email "bot@users.noreply.github.com"
          git add obsidian.ics
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update obsidian.ics from Gist (cleaned)"
            git push
          fi
